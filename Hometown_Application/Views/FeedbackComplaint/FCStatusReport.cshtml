@using Microsoft.AspNetCore.Identity
@using Hometown_Application.Areas.Identity.Data
@inject UserManager<ApplicationUser> UserManager

@model IEnumerable<Hometown_Application.Models.FeedbackComplaintModel>

@{
    var user = await UserManager.GetUserAsync(User);

    // Separate feedback and complaints
    var feedbackItems = Model?.Where(item => item.Type == "Feedback").ToList() ?? new List<Hometown_Application.Models.FeedbackComplaintModel>();
    var complaintItems = Model?.Where(item => item.Type == "Complaint").ToList() ?? new List<Hometown_Application.Models.FeedbackComplaintModel>();

    // Separate based on reply status
    var feedbackWithReply = feedbackItems.Where(item => !string.IsNullOrEmpty(item.AdminReply)).ToList();
    var feedbackWithoutReply = feedbackItems.Where(item => string.IsNullOrEmpty(item.AdminReply)).ToList();

    var complaintWithReply = complaintItems.Where(item => !string.IsNullOrEmpty(item.AdminReply)).ToList();
    var complaintWithoutReply = complaintItems.Where(item => string.IsNullOrEmpty(item.AdminReply)).ToList();

    // Separate by status
    var feedbackByStatus = feedbackItems.GroupBy(item => item.Status.StatusName).ToDictionary(g => g.Key, g => g.ToList());
    var complaintByStatus = complaintItems.GroupBy(item => item.Status.StatusName).ToDictionary(g => g.Key, g => g.ToList());
}

<h1>Feedback</h1>
@foreach (var status in feedbackByStatus.Keys)
{
    <h2>@status Feedback</h2>
    @if (feedbackByStatus[status].Any())
    {
        <h3>With Admin Reply</h3>
        @if (feedbackWithReply.Any())
        {
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Message</th>
                        <th>Reply</th>
                        <th>Submitted On</th>
                        <th>Image</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in feedbackWithReply.Where(f => f.Status.StatusName == status))
                    {
                        <tr>
                            <td>@item.Title</td>
                            <td>@item.Message</td>
                            <td>@item.AdminReply</td>
                            <td>@item.AddedOn.ToString("MM/dd/yyyy")</td>
                            <td>
                                @if (item.Image != null)
                                {
                                    <img src="data:image/jpeg;base64,@Convert.ToBase64String(item.Image)" alt="Feedback Image" width="100" height="100" />
                                }
                                else
                                {
                                    <span>No Image</span>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
        else
        {
            <p>No feedback with admin reply.</p>
        }

        <h3>Without Admin Reply</h3>
        @if (feedbackWithoutReply.Any())
        {
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Message</th>
                        <th>Submitted On</th>
                        <th>Image</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in feedbackWithoutReply.Where(f => f.Status.StatusName == status))
                    {
                        <tr>
                            <td>@item.Title</td>
                            <td>@item.Message</td>
                            <td>@item.AddedOn.ToString("MM/dd/yyyy")</td>
                            <td>
                                @if (item.Image != null)
                                {
                                    <img src="data:image/jpeg;base64,@Convert.ToBase64String(item.Image)" alt="Feedback Image" width="100" height="100" />
                                }
                                else
                                {
                                    <span>No Image</span>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
        else
        {
            <p>No feedback without admin reply.</p>
        }
    }
    else
    {
        <p>No feedback available for @status.</p>
    }
}

<h1>Complaints</h1>
@foreach (var status in complaintByStatus.Keys)
{
    <h2>@status Complaints</h2>
    @if (complaintByStatus[status].Any())
    {
        <h3>With Admin Reply</h3>
        @if (complaintWithReply.Any())
        {
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Message</th>
                        <th>Reply</th>
                        <th>Submitted On</th>
                        <th>Image</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in complaintWithReply.Where(c => c.Status.StatusName == status))
                    {
                        <tr>
                            <td>@item.Title</td>
                            <td>@item.Message</td>
                            <td>@item.AdminReply</td>
                            <td>@item.AddedOn.ToString("MM/dd/yyyy")</td>
                            <td>
                                @if (item.Image != null)
                                {
                                    <img src="data:image/jpeg;base64,@Convert.ToBase64String(item.Image)" alt="Complaint Image" width="100" height="100" />
                                }
                                else
                                {
                                    <span>No Image</span>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
        else
        {
            <p>No complaints with admin reply.</p>
        }

        <h3>Without Admin Reply</h3>
        @if (complaintWithoutReply.Any())
        {
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Message</th>
                        <th>Submitted On</th>
                        <th>Image</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in complaintWithoutReply.Where(c => c.Status.StatusName == status))
                    {
                        <tr>
                            <td>@item.Title</td>
                            <td>@item.Message</td>
                            <td>@item.AddedOn.ToString("MM/dd/yyyy")</td>
                            <td>
                                @if (item.Image != null)
                                {
                                    <img src="data:image/jpeg;base64,@Convert.ToBase64String(item.Image)" alt="Complaint Image" width="100" height="100" />
                                }
                                else
                                {
                                    <span>No Image</span>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
        else
        {
            <p>No complaints without admin reply.</p>
        }
    }
    else
    {
        <p>No complaints available for @status.</p>
    }
}
