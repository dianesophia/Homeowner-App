@{
    ViewData["Title"] = "Event Calendar";
}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>

<style>
    #calendar {
        max-width: 1300px;
        margin: auto;
    }
</style>

<h2 class="text-center">Event Calendar</h2>

<div id="calendar"></div>

<div id="eventModal" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Event</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="eventForm">
                    <div class="form-group">
                        <label>Title:</label>
                        <input type="text" id="eventTitle" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Start Date & Time:</label>
                        <input type="datetime-local" id="eventStart" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>End Date & Time:</label>
                        <input type="datetime-local" id="eventEnd" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Location:</label>
                        <input type="text" id="eventLocation" class="form-control">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="saveEvent">Save Event</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var calendarEl = document.getElementById('calendar');
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'en',
            selectable: true,
            editable: false,
            events: "/Event/GetEvents", // Fetch  from database

            // Click to add an event
            dateClick: function (info) {
                $("#eventStart").val(info.dateStr + "T00:00");
                $("#eventEnd").val(info.dateStr + "T23:59");
                $("#eventModal").modal("show");
            },

            // Right-click delete event
            eventClick: function (info) {
                if (confirm("Do you want to delete this event?")) {
                    $.ajax({
                        url: "/Event/DeleteEvent?id=" + info.event.id,
                        type: "DELETE",
                        success: function (response) {
                            if (response.success) {
                                alert(response.message);
                                info.event.remove();
                            }
                        }
                    });
                }
            }
        });

        calendar.render();

        // public holidays
        fetch('https://date.nager.at/api/v3/PublicHolidays/2024/PH')
            .then(response => response.json())
            .then(holidays => {
                holidays.forEach(holiday => {
                    calendar.addEvent({
                        title: holiday.name,
                        start: holiday.date,
                        color: 'red'
                    });
                });
            })
            .catch(error => console.error('Error fetching holidays:', error));

        //  Save 
        $("#saveEvent").click(function () {
            var newEvent = {
                title: $("#eventTitle").val(),
                dateTimeStart: $("#eventStart").val(),
                dateTimeEnd: $("#eventEnd").val() || null,
                location: $("#eventLocation").val()
            };

            if (!newEvent.title || !newEvent.dateTimeStart) {
                alert("Please fill in the required fields!");
                return;
            }

            $.ajax({
                url: "/Event/AddEvent",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(newEvent),
                success: function (response) {
                    if (response.success) {
                        alert(response.message);
                        calendar.refetchEvents();
                        $("#eventModal").modal("hide");
                        $("#eventForm")[0].reset(); 
                    } else {
                        alert("Failed to save event.");
                    }
                },
                error: function () {
                    alert("Error saving event.");
                }
            });
        });

        //  Close Button 
        $(".close, .btn-secondary").click(function () {
            $("#eventModal").modal("hide");
            $("#eventForm")[0].reset(); 
        });

    });
</script>
